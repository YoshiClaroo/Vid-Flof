<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="ppck-ver" content="47e45ec35fcd8617b1ddc7eae5630650" />
    <title>Video Player</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #fff;
        }
        .player-container {
            width: 90%;
            max-width: 350px;
            padding: 15px;
            background: #fff;
        }
        .video-wrapper {
            position: relative;
        }
        video {
            width: 100%;
            border-radius: 0;
        }
    </style>
    
    <script type="module" src="/firebase.js"></script>
</head>
<body>
    <div class="player-container">
        <div class="video-wrapper">
            <video id="player" playsinline controls muted autoplay>
                <source src="" type="video/mp4">
            </video>
        </div>
    </div>

    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const playerElement = document.getElementById('player');
            
            // Obtener ID de la URL
            const path = window.location.pathname.split('/');
            const id = path[path.length - 1];

            if (!id) {
                playerElement.parentElement.innerHTML = '<p>Error: No se proporcionó un ID válido.</p>';
                return;
            }

            try {
                // Obtener datos de Firestore
                const linkData = await window.dbFunctions.getLink(id);

                if (!linkData) {
                    playerElement.parentElement.innerHTML = '<p>Enlace no válido o expirado.</p>';
                    return;
                }

                const { videoUrl, redirectUrl, popunderCode } = linkData;

                // Depuración: Verificar los datos recibidos
                console.log('Datos de Firestore:', { videoUrl, redirectUrl, popunderCode });

                // Configurar el reproductor con Plyr
                playerElement.src = videoUrl;
                const player = new Plyr(playerElement, {
                    autoplay: true,
                    muted: true,
                    controls: ['play-large', 'progress', 'current-time', 'mute', 'volume', 'fullscreen']
                });

                // Añadir popunderCode como script fijo si existe
                if (popunderCode) {
                    console.log('PopunderCode original:', popunderCode);
                    // Extraer el contenido JavaScript (sin las etiquetas <script>)
                    let scriptContent = popunderCode
                        .replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '')
                        .trim();
                    console.log('PopunderCode limpio:', scriptContent);

                    // Verificar que scriptContent no esté vacío
                    if (scriptContent) {
                        try {
                            // Crear y añadir el script al body
                            const script = document.createElement('script');
                            script.textContent = scriptContent;
                            document.body.appendChild(script);
                            console.log('Popunder script añadido al body');

                            // Depuración: Verificar si el script externo se carga
                            const popTag = document.createElement('script');
                            popTag.src = scriptContent.includes('cdn.popcash.net') ? '//cdn.popcash.net/show.js' : '//cdn2.popcash.net/show.js';
                            popTag.onload = () => console.log('Script Popcash cargado exitosamente');
                            popTag.onerror = (e) => console.error('Error al cargar script Popcash:', e);
                            document.body.appendChild(popTag);
                        } catch (error) {
                            console.error('Error al añadir popunderCode:', error);
                        }
                    } else {
                        console.error('Error: scriptContent está vacío después de limpiar popunderCode');
                    }
                } else {
                    console.log('No hay popunderCode para añadir');
                }

                // Redirección al hacer clic en cualquier parte de la página (solo una vez por sesión)
                let hasRedirectedOnClick = sessionStorage.getItem(`redirectedOnClick_${id}`);
                document.body.addEventListener('click', () => {
                    console.log('Evento click disparado, hasRedirectedOnClick:', hasRedirectedOnClick);
                    if (!hasRedirectedOnClick) {
                        if (redirectUrl) {
                            console.log('Abriendo redirectUrl:', redirectUrl);
                            window.open(redirectUrl, '_blank');
                        }
                        sessionStorage.setItem(`redirectedOnClick_${id}`, 'true');
                        hasRedirectedOnClick = true;
                    } else {
                        console.log('Click ignorado: ya se ejecutó en esta sesión');
                    }
                });

                // Redirección al finalizar el video (solo una vez por sesión)
                let hasRedirectedOnEnd = sessionStorage.getItem(`redirectedOnEnd_${id}`);
                playerElement.addEventListener('ended', () => {
                    console.log('Evento ended disparado, hasRedirectedOnEnd:', hasRedirectedOnEnd);
                    if (!hasRedirectedOnEnd) {
                        if (redirectUrl) {
                            console.log('Abriendo redirectUrl:', redirectUrl);
                            window.open(redirectUrl, '_blank');
                        }
                        sessionStorage.setItem(`redirectedOnEnd_${id}`, 'true');
                        hasRedirectedOnEnd = true;
                    } else {
                        console.log('Ended ignorado: ya se ejecutó en esta sesión');
                    }
                });

                // Forzar autoplay en móviles
                player.on('loadedmetadata', () => {
                    player.muted = true;
                    player.play().catch(e => console.log("Autoplay prevented:", e));
                });
            } catch (error) {
                console.error('Error al cargar el video:', error);
                playerElement.parentElement.innerHTML = '<p>Error al cargar el video.</p>';
            }
        });
    </script>
</body>
</html>
